# modbus协议

##### modbus rtu 、modbus tcp、modbus ascii区别

ModBus协议是应用层报文传输协议（OSI模型第7层），它定义了一个与通信层无关的协议数据单元（PDU），即PDU=功能码+数据域。
ModBus协议能够应用在不同类型的总线或网络。对应不同的总线或网络，Modbus协议引入一些附加域映射成应用数据单元（ADU），即ADU=附加域+PDU。目前，Modbus有下列三种通信方式：

modbus rtu : 数据是按byte传输，一般通过串口RS232/RS422/RS485传输、也可以通过tcp/udp等其他介质。

modbus tcp : 数据是按byte传输，一般通过tcp/udp传输。

modbus ascii : 数据是按十六进制字符表示，传输介质与rtu一样。



### modbus PDU

| 功能码        | 数据区域 |
| ------------- | -------- |
| function code | data     |

### 

### modbus rtu

| 从站地址 | 功能码 | 数据区               | CRC校验   |
| -------- | ------ | -------------------- | --------- |
| 1byte    | 1byte  | 0-252byte            | 2byte     |
| 0x01     | 0x01   | 0x00 0x00  0x00 0x01 | 0xFD 0xCA |
| 0x01     | 0x01   | 0x01 0x00            | 0x51 0x88 |
| 0x01     | 0x03   | 0x00 0x00  0x00 0x01 | 0x84 0x0A |
| 0x01     | 0x03   | 0x02 0x00  0x00      | 0xB8 0x44 |



### modbus tcp

| 报文头                              | 功能码 | 数据区              |
| ----------------------------------- | ------ | ------------------- |
| 7byte                               | 1byte  | 0-252byte           |
| 0x00 0x00 0x00 0x00 0x00 0x06  0x01 | 0x01   | 0x00 0x00 0x00 0x01 |
| 0x00 0x01 0x00 0x00 0x00 0x04 0x01  | 0x01   | 0x01 0x00           |
| 0x00 0x02 0x00 0x00 0x00 0x06 0x01  | 0x02   | 0x00 0x00 0x00 0x01 |
| 0x00 0x02 0x00 0x00 0x00 0x04 0x01  | 0x02   | 0x01 0x00           |
| 0x00 0x03 0x00 0x00 0x00 0x06 0x01  | 0x03   | 0x00 0x00 0x00 0x01 |
| 0x00 0x03 0x00 0x00 0x00 0x05 0x01  | 0x03   | 0x02 0x00 0x00      |



### modbus ascii

| 报文头  | 从站地址      | 功能码        | 数据区    | LRC校验 | 报文尾          |
| ------- | ------------- | ------------- | --------- | ------- | --------------- |
| 1byte   | 2byte         | 2byte         | 0-252byte | 2byte   | 2byte           |
| :(0x3A) | 01(0x30,0x31) | 01(0x30,0x31) | ...       |         | \n\r(0x0D,0x0A) |



### 从站地址：

0：表示主机

1-



### 线圈/寄存器：

##### 线圈 coil :  保持线圈、输入线圈   

一个单位只有1bit,只有1,0两个状态。保持线圈可读可写，输入线圈只能读。

##### 寄存器register： 保持寄存器、输入寄存器  

 一个单位只有16bit,可以表示0-4095。保持寄存器可读可写，输入寄存器只能读。



### 功能码：

##### 0x01 读保持线圈 HOLDING_COILS：



##### 0x02 读输入线圈 INPUTS_COILS：



##### 0x03 读保持寄存器 HOLDING_REGISTERS：



##### 0x04 读输入寄存器 INPUT_REGISTERS：



##### 0x05 写单个保持线圈：



##### 0x06 写单个保持寄存器：



##### 0x07 读异常状态码：



##### 0x0F 写多个保持线圈



##### 0x10 写多个保持寄存器



##### 0x11 上报从机地址





# modbus流程

​    

##### 主机（master）查询 poll

主机 ---查询--->  从机 ---应答--->  主机

   

##### 从机（slave）等待查询 wait 

从机 ---等待主机查询--->  处理数据  ---应答--->  主机

​    

查询: 读线圈、读寄存器、写线圈、写寄存器、读从机地址、读错误码

应答: 正常应答、错误应答

   



### 0x01、0x02 读线圈 PDU格式

| 功能码 | 起始线圈地址     | 线圈个数         |
| ------ | ---------------- | ---------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 |

##### 应答 PDU格式

| 功能码 | 数据长度 | 数据（1bit表示一个线圈） |
| ------ | -------- | ------------------------ |
| 1byte  | 1byte    | 数据长度                 |

   

### 0x03、0x04 读寄存器 PDU格式

| 功能码 | 起始寄存器地址   | 寄存器个数       |
| ------ | ---------------- | ---------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 |

##### 应答 PDU格式

| 功能码 | 数据长度 | 数据（16bit表示一个寄存器） |
| ------ | -------- | --------------------------- |
| 1byte  | 1byte    | 数据长度                    |

   



### 0x05写单个线圈 PDU格式

| 功能码 | 起始线圈地址     | 状态数据             |
| ------ | ---------------- | -------------------- |
| 1byte  | 2byte 高字节在前 | 2byte（ 高字节有效） |

##### 应答 PDU格式

| 功能码 | 起始线圈地址     | 状态数据              |
| ------ | ---------------- | --------------------- |
| 1byte  | 2byte 高字节在前 | 2byte （ 高字节有效） |



### 0x0F 写多个线圈 PDU格式

| 功能码 | 起始线圈地址     | 线圈个数         | 数据长度 | 数据(一个线圈占1bit) |
| ------ | ---------------- | ---------------- | -------- | -------------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 | 1byte    | 数据长度             |

##### 应答 PDU格式

| 功能码 | 起始线圈地址     | 线圈个数         |
| ------ | ---------------- | ---------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 |



   

### 0x06 写单个寄存器 PDU格式

| 功能码 | 起始寄存器地址   | 数据             |
| ------ | ---------------- | ---------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 |

##### 应答 PDU格式

| 功能码 | 起始寄存器地址   | 数据             |
| ------ | ---------------- | ---------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 |



### 0x10 写多个寄存器 PDU格式

| 功能码 | 起始寄存器地址   | 寄存器个数       | 数据长度 | 数据(一个寄存器占16bit) |
| ------ | ---------------- | ---------------- | -------- | ----------------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 | 1byte    | 数据长度                |

##### 应答 PDU格式

| 功能码 | 起始寄存器地址   | 寄存器个数       |
| ------ | ---------------- | ---------------- |
| 1byte  | 2byte 高字节在前 | 2byte 高字节在前 |



   















